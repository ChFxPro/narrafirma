<!DOCTYPE html>
<html>

<head>
<title>NarraCoach</title>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dojo/resources/dojo.css">
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dijit/themes/dijit.css">
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dijit/themes/claro/claro.css">
<style type="text/css">
  @import "http://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dojox/grid/resources/claroGrid.css";

  /*Grid needs an explicit height by default*/
  #gridDiv {
      height: 30em;
  }
</style>
<script>dojoConfig = {async: true, parseOnLoad: false}</script>
<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dojo/dojo.js"></script>
</head>

<body class="claro">
  <b>NarraCoach</b><br>
  
  <div id="questionsDiv"></div>
  <div id="testDiv"></div>
  <hr>
  <div id="surveyDiv"></div>
  
  <script>
"use strict";
require(["dijit/form/Button", "dojo/dom", "dijit/Dialog", "dojo/on", "dojo/query", "dojo/_base/array", "dojo/domReady!"], function(Button, dom, Dialog, on, query, array){
  
  var testPuppyQuestions = [
    {id: "name", type: "text", text: "Your Name", help: 'Please enter your \'full\' name, like "John Smith".'},
    {id: "wantPuppy", type: "boolean", text: "Do you want a free puppy today?", help: "Enter yes or no"},
    {id: "reason", type: "text", text: "If yes, why do you want a free puppy?"},
  ];
  
  var createSurveyQuestions = [
    {id: "questionID", type: "text", text: "Question ID", help: 'TODO'},
    {id: "questionType", type: "select", text: "Question Type", help: 'TODO', options: "text\ntextarea\nboolean\nselect"},
    {id: "questionText", type: "textarea", text: "Question Text", help: 'TODO'},
    {id: "questionHelp", type: "textarea", text: "Question Help", help: 'TODO'},
    {id: "questionOptions", type: "textarea", text: "Question Options", help: 'Enter options here, one per line'},
  ];

  function insertQuestionIntoDiv(question, questionsDiv) {
    // console.log("question", question);
    var input;
    if (question.type === "boolean") {
      input = '<input type="radio" name="' + question.id + '" value="No"> No <input type="radio" name="' + question.id + '" value="Yes"> Yes ';
    } else if (question.type === "text") {
      input = '<input type="text" id="' + question.id + '">';
    } else if (question.type === "textarea") {
      input = '<br><textarea id="' + question.id + '"></textarea>';
    } else if (question.type === "select") {
      var options = "";
      if (question.options) {
        if (!question.value) options += "<option disabled selected> -- select an option -- </option>";
        array.forEach(question.options.split("\n"), function(each) {
          var selected = "";
          if (each === question.value) selected = " selected";
          options += '<option value="' + each + '"' + selected + '>' + each + '</option>';
        });
      } else {
        console.log("No options specified");
      }
      input = '<select id="' + question.id + '">' + options + '</select>';
    } else {
      console.log("Unsupported question type: " + question.type);
      return;
    }
    
    var help = "";
    if (question.help) {
      var helpText = question.help.replace(/\"/g, '\\x22').replace(/\'/g, '\\x27');;
      help = ' <button onclick="alert(\'' + helpText + '\')">?</button>';
    }
    
    var questionDiv = document.createElement("div");
    questionDiv.className = "narracoachQuestion";
    questionDiv.innerHTML = question.text + " " + input + help + "<br><br>";
    questionsDiv.appendChild(questionDiv);
    
    // console.log("question", question, question.value);
    if (question.type === "text") {
      var node = questionDiv.querySelector("#" + question.id);
      if (node && question.value) node.value = question.value;
    } else if (question.type === "textarea") {
      var node = questionDiv.querySelector("#" + question.id);
      if (node && question.value) node.innerHTML = question.value;
    } else if (question.type === "boolean") {
      var node = questionDiv.querySelector("#" + question.id);
      if (node && question.value) node.value = question.value;
    //} else if (question.type === "select") {
    //  var node = questionDiv.querySelector("#" + question.id);
    //  if (node && question.value) node.value = question.value;
    }
  }
  
  function questionEditDialogOK(question, questionEditorDiv, form) {
      var changed = false;
      
      var questionID = form.querySelector("#questionID").value;
      if (questionID !== question.id) {
        changed = true;
        question.id = questionID;
      }
      
      var questionType = form.querySelector("#questionType").value;
      if (questionType !== question.type) {
        changed = true;
        question.type = questionType;
      }
      
      var questionText = form.querySelector("#questionText").value;
      if (questionText !== question.text) {
        changed = true;
        question.text = questionText;
      }
      
      var questionHelp = form.querySelector("#questionHelp").value;
      if (questionHelp !== question.help) {
        changed = true;
        question.help = questionHelp;
      }
      
      var questionOptions = form.querySelector("#questionOptions").value;
      if (questionOptions !== question.options) {
        changed = true;
        question.options = questionOptions;
      }
      
      console.log("changed", changed);
      if (changed) {
        questionEditorDiv.innerHTML = "";
        insertQuestionEditorIntoDiv(question, questionEditorDiv);
      }
  }
  
  function showQuestionEditDialog(question, questionEditorDiv) {
    var questionEditDialog;
    
    var form = document.createElement("div");
    // "<pre>" + JSON.stringify(question) + "</pre>"
    
    // Fill in defaults
    createSurveyQuestions[0].value = question.id;
    createSurveyQuestions[1].value = question.type;
    createSurveyQuestions[2].value = question.text;
    createSurveyQuestions[3].value = question.help;
    
    insertQuestionsIntoDiv(createSurveyQuestions, form);
    
    // TODO: Does the dialog have to be "destroyed"???
    
    newButton("OK", form, function() {
      console.log("OK");
      questionEditDialog.hide();
      questionEditDialogOK(question, questionEditorDiv, form);
    });
    
    newButton("Cancel", form, function() {
      console.log("Cancel");
      questionEditDialog.hide();
    });

    questionEditDialog = new Dialog({
      title: "Edit question " + question.index,
      content: form,
      style: "width: 600px"
    });

    questionEditDialog.show();
  }
  
  function isString(something) {
    return (typeof something == 'string' || something instanceof String);
  }
    
  function newButton(label, addToDiv, callback) {
    var button = new Button({
      label: label,
      type: "button",
      onClick: callback
    });
    if (isString(addToDiv)) {
      addToDiv = document.getElementById(addToDiv);
    }
    if (addToDiv) {
      addToDiv.appendChild(button.domNode);
    }
    button.startup();
    return button;
  }
  
  function insertQuestionEditorIntoDiv(question, questionEditorDiv) {
    var idLabel = document.createElement("span");
    idLabel.innerHTML = "<b>" + question.id + "</b>";
    questionEditorDiv.appendChild(idLabel);
    var editButton = newButton("Edit", questionEditorDiv, function() {
      showQuestionEditDialog(question, questionEditorDiv);
    });
    var deleteButton = newButton("Delete", questionEditorDiv, function() {
      if (confirm("Proceed to delete question " + question.id + "?")) {
        questionEditorDiv.parentNode.removeChild(questionEditorDiv);
        }
    });
    questionEditorDiv.appendChild(document.createElement("br"));
    insertQuestionIntoDiv(question, questionEditorDiv);
    questionEditorDiv.appendChild(document.createElement("br"));
    questionEditorDiv.setAttribute("data-narracoach-question", JSON.stringify(question));
  }
    
  function insertQuestionEditorDivIntoDiv(question, questionsDiv) {
    var questionEditorDiv = document.createElement("div");
    questionEditorDiv.className = "narracoachQuestionEditor";
    insertQuestionEditorIntoDiv(question, questionEditorDiv);
    questionsDiv.appendChild(questionEditorDiv);
  }
  
  function insertQuestionsIntoDiv(questions, questionsDiv) {
	  for (var questionIndex in questions) {
		var question = questions[questionIndex];
		question.index = questionIndex;
		insertQuestionIntoDiv(question, questionsDiv)
	  }
  }
  
  var questionsDiv = document.getElementById("questionsDiv");
  //insertQuestionsIntoDiv(testPuppyQuestions, questionsDiv);
  // insertQuestionsIntoDiv(createSurveyQuestions, questionsDiv);
  
  // TODO: Challenge of repeating sections....
      
  function addQuestion() {
    questionsDiv.innerHTML += "<div>Add question button pressed at: " + Date.now() + "</div>";
  }
  
  var questionIndex = 1;
  
  function addQuestion() {
    var question = {index: questionIndex, id: "Q" + questionIndex, type: "text", text: "Question text " + questionIndex, help: 'Question help ' + questionIndex};
    questionIndex += 1;
    insertQuestionEditorDivIntoDiv(question, questionsDiv);
  }
  
  function submitSurvey() {
    var answers = {};
    console.log("submitSurvey pressed");
    var nodes = query(".narracoachQuestion", "surveyDiv");
    // console.log("nodes", nodes);
    nodes.forEach(function(node) {
      // console.log("Node", node);
      var questionID = "FIXME";
      var questionValue = "FIXME";
      // answers[
    });
  }
  
  function exportSurveyQuestions() {
    var questions = [];
    var nodes = query(".narracoachQuestionEditor", "questionsDiv");
    // console.log("nodes", nodes);
    nodes.forEach(function(node) {
      // console.log("Node", node);
      var questionText = node.getAttribute("data-narracoach-question");
      var question = JSON.parse(questionText);
      questions.push(question);
    });
    console.log("questions", JSON.stringify(questions));
    var surveyDiv = document.getElementById("surveyDiv");
    surveyDiv.innerHTML = "";
    insertQuestionsIntoDiv(questions, surveyDiv);
    var submitSurveyButton = newButton("Submit survey", "surveyDiv", submitSurvey);
  }
  
  // Create a button programmatically:
  var addQuestionButton = newButton("Add question", "testDiv", addQuestion);
  document.getElementById("testDiv").appendChild(document.createElement("br"));
  var exportButton = newButton("Export survey questions", "testDiv", exportSurveyQuestions);
});
  </script>
</body>

</html>
